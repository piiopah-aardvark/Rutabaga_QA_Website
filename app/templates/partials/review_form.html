<div x-data='reviewForm({{ response.id }}, {{ response.segments | tojson }}, {{ previous_review | tojson if previous_review else "null" }})' class="space-y-6">
    <!-- Re-review Banner -->
    {% if previous_review %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-sm font-medium text-yellow-800">RE-REVIEW MODE</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p><strong>Previous review:</strong> Submitted on {{ previous_review.submitted_at[:10] if previous_review.submitted_at else 'Unknown' }} | Avg Score: <span class="font-bold">{{ previous_review.avg_score }}</span>/5</p>
                    {% if previous_review.rereview_reason %}
                    <p class="mt-1"><strong>Reason for re-review:</strong> {{ previous_review.rereview_reason }}</p>
                    {% endif %}
                    <button @click="showPreviousReview = !showPreviousReview"
                            class="mt-2 text-xs font-medium text-yellow-900 hover:text-yellow-800 underline">
                        <span x-text="showPreviousReview ? 'Hide' : 'Show'"></span> previous scores
                    </button>
                </div>
            </div>
        </div>

        <!-- Previous Review Details (Collapsible) -->
        <div x-show="showPreviousReview" x-collapse class="mt-4 border-t border-yellow-200 pt-4">
            <h4 class="text-xs font-medium text-yellow-900 mb-2">Previous Segment Scores:</h4>
            <div class="space-y-1">
                <template x-for="(scoreData, segmentId) in previousReview.segment_scores" :key="segmentId">
                    <div class="text-xs text-yellow-800">
                        <span class="font-medium" x-text="segmentId"></span>:
                        Score <span x-text="scoreData.score"></span>/5
                        <span x-show="scoreData.suggestion" class="italic ml-2">- Had suggestion</span>
                    </div>
                </template>
            </div>
            {% if previous_review.overall_notes %}
            <div class="mt-2 text-xs text-yellow-800">
                <span class="font-medium">Previous notes:</span> {{ previous_review.overall_notes }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Query Display -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-sm font-medium text-blue-900 mb-2">Query</h3>
        <p class="text-lg text-blue-800">{{ response.query_text }}</p>
    </div>

    <!-- Phase 1 Response (Subject) -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <h3 class="text-sm font-medium text-green-900 mb-2">Response</h3>
        <p class="text-lg text-green-800 font-medium">{{ phase1_subject }}...</p>
    </div>

    <!-- Segments Scoring -->
    <div class="space-y-4">
        {% for segment in response.segments %}
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
                            {{ segment.id }}
                        </span>
                        <span class="text-xs text-gray-500">{{ segment.variant_id }}</span>
                    </div>
                    <p class="text-gray-900">{{ segment.text }}</p>
                </div>
            </div>

            <!-- Score Radio Buttons -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Score (0-5)</label>
                <div class="flex space-x-4">
                    {% for score in range(6) %}
                    <label class="flex items-center cursor-pointer">
                        <input type="radio"
                               name="score_{{ segment.id }}"
                               value="{{ score }}"
                               x-model="scores.{{ segment.id }}.score"
                               class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <span class="ml-1.5 text-sm {% if score == 0 %}text-red-600{% elif score <= 2 %}text-orange-600{% elif score <= 3 %}text-yellow-600{% else %}text-green-600{% endif %} font-medium">
                            {{ score }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Suggestion Input -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Suggested Improvement (optional)
                </label>
                <textarea x-model="scores.{{ segment.id }}.suggestion"
                          rows="2"
                          placeholder="Enter improved text for this segment..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"></textarea>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Overall Notes -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Notes (optional)
        </label>
        <textarea x-model="overallNotes"
                  rows="3"
                  placeholder="Additional comments about this response..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"></textarea>
    </div>

    <!-- Source Data Button -->
    <div class="flex items-center space-x-4">
        <button @click="toggleSourceData()"
                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
            <span x-text="showSourceData ? 'Hide FDA Source Content' : 'View FDA Source Content'"></span>
        </button>
    </div>

    <!-- Source Data Panel (collapsible) -->
    <div x-show="showSourceData" x-collapse class="bg-gray-50 border border-indigo-200 rounded-lg p-4">
        <div class="mb-4">
            <h4 class="text-sm font-medium text-gray-900 mb-1">FDA DailyMed Source Content</h4>
            <p class="text-xs text-gray-600">These are the actual FDA source quotes and metadata used to generate this response.</p>
        </div>

        <template x-if="loadingSourceData">
            <div class="flex items-center justify-center py-8">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span class="ml-3 text-sm text-gray-600">Loading source data...</span>
            </div>
        </template>

        <template x-if="!loadingSourceData && sourceData">
            <div class="space-y-4">
                <template x-for="(value, key) in sourceData" :key="key">
                    <div x-show="!key.startsWith('_separator')">
                        <!-- Special formatting for FDA Source Quotes -->
                        <div x-show="key === 'FDA Source Quotes' && Array.isArray(value)" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <h4 class="text-sm font-bold text-yellow-900 mb-3">FDA DailyMed Source Quotes</h4>
                            <div class="space-y-3">
                                <template x-for="(quote, idx) in value" :key="idx">
                                    <div class="bg-white border border-yellow-200 rounded p-3">
                                        <div class="text-sm text-gray-900 mb-2 italic" x-text="quote.text"></div>
                                        <div class="flex items-center space-x-4 text-xs text-gray-600">
                                            <span><strong>Section:</strong> <span x-text="quote.section"></span></span>
                                            <span><strong>Position:</strong> <span x-text="quote.position"></span></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Regular field display -->
                        <div x-show="key !== 'FDA Source Quotes'" class="bg-white border border-gray-200 rounded-lg p-3">
                            <div class="text-xs font-semibold text-indigo-700 uppercase tracking-wide mb-1" x-text="key.replace(/_/g, ' ')"></div>

                            <!-- URL link -->
                            <a x-show="typeof value === 'string' && value.startsWith('http')"
                               :href="value"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="text-sm text-indigo-600 hover:text-indigo-800 underline flex items-center">
                                <span>View Full FDA Drug Label</span>
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>

                            <!-- Non-URL content -->
                            <div x-show="!(typeof value === 'string' && value.startsWith('http'))"
                                 class="text-sm text-gray-900 whitespace-pre-wrap"
                                 :class="typeof value === 'object' ? 'font-mono text-xs' : ''"
                                 x-text="typeof value === 'object' ? JSON.stringify(value, null, 2) : (value || '(empty)')"></div>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <template x-if="!loadingSourceData && !sourceData">
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-500">No source data available</p>
            </div>
        </template>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
        <div class="flex space-x-3">
            <button @click="skip()"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Skip
            </button>
            <button @click="flag()"
                    class="px-4 py-2 border border-orange-300 rounded-md text-sm font-medium text-orange-700 bg-white hover:bg-orange-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                Flag for Review
            </button>
        </div>
        <div class="flex space-x-3">
            <button @click="saveDraft()"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Save as Draft
            </button>
            <button @click="submit()"
                    :disabled="!canSubmit()"
                    :class="canSubmit() ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                    class="px-4 py-2 rounded-md text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Submit
            </button>
        </div>
    </div>
</div>
