<div x-data="reviewForm({{ response.id }}, {{ response.segments | tojson }})" class="space-y-6">
    <!-- Query Display -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-sm font-medium text-blue-900 mb-2">Query</h3>
        <p class="text-lg text-blue-800">{{ response.query_text }}</p>
    </div>

    <!-- Phase 1 Response (Subject) -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <h3 class="text-sm font-medium text-green-900 mb-2">Response</h3>
        <p class="text-lg text-green-800 font-medium">{{ phase1_subject }}...</p>
    </div>

    <!-- Segments Scoring -->
    <div class="space-y-4">
        {% for segment in response.segments %}
        <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
                            {{ segment.id }}
                        </span>
                        <span class="text-xs text-gray-500">{{ segment.variant_id }}</span>
                    </div>
                    <p class="text-gray-900">{{ segment.text }}</p>
                </div>
            </div>

            <!-- Score Radio Buttons -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Score (0-5)</label>
                <div class="flex space-x-4">
                    {% for score in range(6) %}
                    <label class="flex items-center cursor-pointer">
                        <input type="radio"
                               name="score_{{ segment.id }}"
                               value="{{ score }}"
                               x-model="scores.{{ segment.id }}.score"
                               class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <span class="ml-1.5 text-sm {% if score == 0 %}text-red-600{% elif score <= 2 %}text-orange-600{% elif score <= 3 %}text-yellow-600{% else %}text-green-600{% endif %} font-medium">
                            {{ score }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Suggestion Input -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Suggested Improvement (optional)
                </label>
                <textarea x-model="scores.{{ segment.id }}.suggestion"
                          rows="2"
                          placeholder="Enter improved text for this segment..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"></textarea>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Overall Notes -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Notes (optional)
        </label>
        <textarea x-model="overallNotes"
                  rows="3"
                  placeholder="Additional comments about this response..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"></textarea>
    </div>

    <!-- Source Data Button -->
    <div class="flex items-center space-x-4">
        <button @click="showSourceData = !showSourceData"
                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
            <span x-text="showSourceData ? 'Hide Source Data' : 'View Source Data'"></span>
        </button>
        <a href="#" class="text-sm text-gray-600 hover:text-gray-800">
            View Original Source (Re-ingest)
        </a>
    </div>

    <!-- Source Data Panel (collapsible) -->
    <div x-show="showSourceData" x-collapse class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-900 mb-2">Source Data</h4>
        <pre class="text-xs text-gray-700 overflow-auto">{{ response.source_references | tojson(indent=2) }}</pre>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
        <div class="flex space-x-3">
            <button @click="skip()"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Skip
            </button>
            <button @click="flag()"
                    class="px-4 py-2 border border-orange-300 rounded-md text-sm font-medium text-orange-700 bg-white hover:bg-orange-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                Flag for Review
            </button>
        </div>
        <div class="flex space-x-3">
            <button @click="saveDraft()"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Save as Draft
            </button>
            <button @click="submit()"
                    :disabled="!canSubmit()"
                    :class="canSubmit() ? 'bg-indigo-600 hover:bg-indigo-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                    class="px-4 py-2 rounded-md text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Submit
            </button>
        </div>
    </div>

    <!-- Scoring Guide Link -->
    <div class="text-center">
        <button @click="$dispatch('open-scoring-guide')"
                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
            ðŸ“– View Scoring Guide
        </button>
    </div>
</div>

<script>
function reviewForm(responseId, segments) {
    return {
        responseId: responseId,
        showSourceData: false,
        overallNotes: '',
        scores: segments.reduce((acc, seg) => {
            acc[seg.id] = { score: null, suggestion: '' };
            return acc;
        }, {}),

        canSubmit() {
            // All segments must have a score
            return Object.values(this.scores).every(s => s.score !== null);
        },

        getSegmentScores() {
            return this.scores;
        },

        async skip() {
            const response = await fetch('/api/review/skip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ response_id: this.responseId })
            });

            if (response.ok) {
                this.loadNext();
            }
        },

        async flag() {
            const reason = prompt('Why are you flagging this response?\n\n(e.g., "Incorrect slots", "Bad ingestion", "Other issue")');
            if (!reason) return;

            const response = await fetch('/api/review/flag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    response_id: this.responseId,
                    flag_reason: reason,
                    segment_scores: this.getSegmentScores(),
                    overall_notes: this.overallNotes
                })
            });

            if (response.ok) {
                alert('Response flagged for admin review');
                this.loadNext();
            }
        },

        async saveDraft() {
            const response = await fetch('/api/review/draft', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    response_id: this.responseId,
                    segment_scores: this.getSegmentScores(),
                    overall_notes: this.overallNotes
                })
            });

            if (response.ok) {
                alert('Draft saved successfully');
                this.loadNext();
            }
        },

        async submit() {
            if (!this.canSubmit()) return;

            const response = await fetch('/api/review/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    response_id: this.responseId,
                    segment_scores: this.getSegmentScores(),
                    overall_notes: this.overallNotes
                })
            });

            const data = await response.json();
            if (data.success) {
                // Show success toast
                this.showToast(data.message);
                // Update stats
                htmx.trigger('#stats-bar', 'refresh');
                // Load next
                this.loadNext();
            }
        },

        loadNext() {
            // Trigger HTMX to load next response
            const intent = document.querySelector('select[name="intent"]').value;
            htmx.ajax('GET', `/api/next-response?intent=${intent}`, '#review-form');
        },

        showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    }
}
</script>
