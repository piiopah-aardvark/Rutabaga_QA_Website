{% extends "base.html" %}

{% block title %}Review - Rutabaga QA{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Stats Bar -->
    <div id="stats-bar"
         class="bg-white rounded-lg shadow-sm p-4 mb-6 flex justify-between items-center"
         hx-get="{{ url_for('api.session_stats') }}"
         hx-trigger="load, refresh from:body"
         hx-swap="none">
        <div>
            <span class="text-sm text-gray-600">Session:</span>
            <span class="font-semibold text-gray-900" id="session-count">0</span>
            <span class="text-sm text-gray-600">reviews</span>
        </div>
        <div>
            <span class="text-sm text-gray-600">All-time:</span>
            <span class="font-semibold text-gray-900" id="total-count">{{ current_user.total_reviews_submitted }}</span>
            <span class="text-sm text-gray-600">reviews</span>
        </div>
    </div>

    <!-- Intent Selector -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Intent</label>
        <select name="intent"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                hx-get="{{ url_for('api.get_next_response') }}"
                hx-target="#review-form"
                hx-swap="innerHTML"
                hx-include="this">
            <option value="" selected disabled>-- Select an intent to review --</option>
            <option value="interaction">Interaction</option>
            <option value="dosing">Dosing</option>
            <option value="drug_dose_rsi">Drug Dose RSI</option>
            <option value="bp_target">BP Target</option>
            <option value="contraindication">Contraindication</option>
            <option value="pregnancy">Pregnancy</option>
            <option value="lactation">Lactation</option>
            <option value="renal_dosing">Renal Dosing</option>
            <option value="hepatic_dosing">Hepatic Dosing</option>
            <option value="pediatric_dosing">Pediatric Dosing</option>
            <option value="iv_compatibility">IV Compatibility</option>
            <option value="calculator">Calculator</option>
        </select>
    </div>

    <!-- Review Form -->
    <div id="review-form" class="bg-white rounded-lg shadow-sm p-6">
        <div class="text-center text-gray-500 py-12">
            <p class="text-lg mb-2">Select an intent to start reviewing</p>
            <p class="text-sm">Responses will auto-load when available</p>
        </div>
    </div>
</div>

<script>
// Update stats when HTMX fetches session stats
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.xhr) {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            if (response.session_reviews !== undefined) {
                document.getElementById('session-count').textContent = response.session_reviews;
                document.getElementById('total-count').textContent = response.total_reviews;
            }
        } catch (e) {
            // Not JSON, ignore
        }
    }

    // Tell Alpine.js to initialize components in the swapped content
    if (window.Alpine && evt.detail.target) {
        window.Alpine.initTree(evt.detail.target);
    }
});
</script>
{% endblock %}
